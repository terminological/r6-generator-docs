<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>R6 Generator Maven Plugin: Key features • testRapi</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="R6 Generator Maven Plugin: Key features">
<meta property="og:description" content="testRapi">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">testRapi</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9999</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/testRapi.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/R6-generator-datatypes.html">R6 Generator Maven Plugin: Datatype conversion</a>
    </li>
    <li>
      <a href="../articles/R6-generator-features.html">R6 Generator Maven Plugin: Key features</a>
    </li>
    <li>
      <a href="../articles/R6-generator-intro.html">R6 Generator Maven Plugin: Bridging Java and R6 for Package Development</a>
    </li>
    <li>
      <a href="../articles/R6-generator-maven-config.html">R6 Generator Maven Plugin: Metadata and Maven configuration</a>
    </li>
    <li>
      <a href="../articles/R6-generator-runtime.html">R6 Generator Runtime: Using R Datatypes in Java</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>R6 Generator Maven Plugin: Key features</h1>
                        <h4 class="author">Rob Challen</h4>
            
            <h4 class="date">19/10/2020</h4>
      
      
      <div class="hidden name"><code>R6-generator-features.Rmd</code></div>

    </div>

    
    
<div class="watermark">
DRAFT
</div>
<div id="features" class="section level2">
<h2 class="hasAnchor">
<a href="#features" class="anchor"></a>Features</h2>
<p>The <code>FeatureTest</code> Java class is designed to showcase the main aspects of the R6 Generator Maven Plugin, and serves as a quick guide to Java programmers wishing to use the plugin. The source of the <code>FeatureTest</code> class is shown below, where the use of the Java annotations <code>@RClass</code> and <code>@RMethod</code> tag a class, and specific methods in that class for use in R. The code structure, parameters and return values or the tagged classes and methods are used to create an equivalent R6 class structure in an R library. In general Javadoc comments and tags are used to document the library, and where there are no applicable tags specific fields in the <code>@RClass</code> and <code>@RMethod</code> annotations can been used to specify needed imports, suggested R package dependencies and provide specific example code if needed.</p>
<pre><code>CANNOT FIND FILE - possibly if running in R-CMD-check</code></pre>
<p>The packaging of this class into an R library is described <a href="./R6-generator-intro">elsewhere</a>. The package name (in this case <code>testRapi</code>), the directory of the library (in this example <code>~/Git/r6-generator-maven-plugin-test/r-library/</code>) and other metadata such as author and license details are defined in the Maven plugin configuration (in a file named <code>pom.xml</code>). This configuration is described in detail <a href="./R6-generator-maven-config">elsewhere</a>. For the purposes of this we assume the Java code has been compiled, generating the <code>testRapi</code> R package which is ready for installation.</p>
</div>
<div id="installation-and-instantiation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation-and-instantiation" class="anchor"></a>Installation and instantiation</h2>
<p>The generated R package can be installed into R in more or less the same way as any other R library, depending on how it is deployed. Typical scenarios would be pushing the whole Java project to Github and installing to R from Github using <code><a href="https://devtools.r-lib.org/reference/remote-reexports.html">devtools::install_github()</a></code>, installing directly from the local filesystem, with <code><a href="https://devtools.r-lib.org/reference/install.html">devtools::install()</a></code>, or submitting the R library sub-directory as a project to CRAN and installing from there, using <code><a href="https://rdrr.io/r/utils/install.packages.html">install.packages()</a></code>.</p>
<div class="sourceCode"><pre class="downlit">
<span class="co"># not run</span>
<span class="co"># remove installed versions</span>
<span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/detach.html">detach</a></span><span class="op">(</span><span class="st">"package:testRapi"</span>, unload <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/remove.packages.html">remove.packages</a></span><span class="op">(</span><span class="st">"testRapi"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span>list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ls.html">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></pre></div>
<p>Restarting R maybe also required if there was a running java VM.</p>
<div class="sourceCode"><pre class="downlit">
<span class="co"># locally compiled</span>
<span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/install.html">install</a></span><span class="op">(</span><span class="st">"~/Git/r6-generator-docs"</span>, upgrade <span class="op">=</span> <span class="st">"never"</span><span class="op">)</span>
<span class="co"># pushed to github</span>
<span class="co"># devtools::install_github("terminological/r6-generator-docs", upgrade = "never")</span>
<span class="co"># submitted to CRAN</span>
<span class="co"># install.packages("testRapi")</span></pre></div>
<p>The R6 api to the Java classes requires a running instance of the Java Virtual Machine and JNI bridge provided by <em>rJava</em>. It also requires Java classpath dependencies to be loaded and application logging to be initialised. This is all managed by a specific generated R6 class called <code>JavaApi</code> and creating a singleton instance of this is the first step to using the library in R. In these examples the singleton instance <code>J</code> is referred to as the "root" of the api, as all the functions of the API stem from it.</p>
<div class="sourceCode"><pre class="downlit">
<span class="va">J</span> <span class="op">=</span> <span class="fu">testRapi</span><span class="fu">::</span><span class="va"><a href="../reference/JavaApi.html">JavaApi</a></span><span class="op">$</span><span class="fu">get</span><span class="op">(</span>logLevel <span class="op">=</span> <span class="st">"WARN"</span><span class="op">)</span></pre></div>
<pre><code>## Initialising A test library</code></pre>
<pre><code>## Version: 0.0.0.9999</code></pre>
<pre><code>## Generated: 2022-06-23T13:31:57.814440</code></pre>
<pre><code>## </code></pre>
<div class="sourceCode"><pre class="downlit">
<span class="va">J</span><span class="op">$</span><span class="fu">changeLogLevel</span><span class="op">(</span><span class="st">"DEBUG"</span><span class="op">)</span>
<span class="va">J</span><span class="op">$</span><span class="va">.log</span><span class="op">$</span><span class="fu">debug</span><span class="op">(</span><span class="st">"prove the logger is working and outputting debug statements..."</span><span class="op">)</span>
<span class="va">J</span><span class="op">$</span><span class="fu">printMessages</span><span class="op">(</span><span class="op">)</span></pre></div>
<pre><code>## 2022-06-23 13:32:17,793 DEBUG testRapi [main] prove the logger is working and outputting debug statements...</code></pre>
<p>Using the <code>FeatureTest</code> class above requires a creating a new instance of the class. This is done through the root of the api as follows, and the <code>FeatureTest</code> constructor simply logs the <code>logMessage</code> parameter's value.</p>
<div class="sourceCode"><pre class="downlit">
<span class="va">feat1</span> <span class="op">=</span> <span class="va">J</span><span class="op">$</span><span class="va">FeatureTest</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>logMessage <span class="op">=</span> <span class="st">"Hello world. Creating a new object"</span><span class="op">)</span></pre></div>
<pre><code>## 2022-06-23 13:32:17,865 INFO uk.co.terminological.rjava.test.FeatureTest [main] Hello world. Creating a new object</code></pre>
</div>
<div id="predictable-data-type-conversion" class="section level2">
<h2 class="hasAnchor">
<a href="#predictable-data-type-conversion" class="anchor"></a>Predictable data type conversion</h2>
<pre><code>CANNOT FIND FILE - possibly if running in R-CMD-check</code></pre>
<p>The <code>FeatureClass.doHelloWorld()</code> method takes no arguments and returns a value to R. A detailed discussion of R and Java data types is to be found elsewhere but our approach has involved developing a specific set of Java datatypes that have close relationships to the native R datatypes. This enables loss-less round tripping of data from R to Java and back again, but requires the mapping of Java data types to R. This is handled by the <code>uk.co.terminological.rjava.RConverter</code> class which provides a range of datatype transformers, and the <code>uk.co.terminological.rjava.types.*</code> classes which specify Java equivalents to R data types. These are needed as R's dynamic datatypes contain concepts which are not readily represented in the primitive java datatypes that are transferred across the JNI. Thus some marshaling is required on both sides to ensure translation is 100% accurate, including for example, conversion of R logical vectors containing NA values, to java <code>List&lt;Boolean&gt;</code> via JNI primitive arrays, or support for typed NA values (e.g. <code>NA_int_</code> versus <code>NA_logical_</code>).</p>
<p>The <code>doHelloWorld()</code> function returns a character vector, The <code>doSum()</code> function expects 2 R numeric values and seamlessly handles both datatype coercion and NA values.</p>
<div class="sourceCode"><pre class="downlit">
<span class="va">feat1</span><span class="op">$</span><span class="fu">doHelloWorld</span><span class="op">(</span><span class="op">)</span></pre></div>
<pre><code>## </code></pre>
<pre><code>## [1] "Hello world from Java!"</code></pre>
<div class="sourceCode"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">feat1</span><span class="op">$</span><span class="fu">doHelloWorld</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></pre></div>
<pre><code>## </code></pre>
<pre><code>## [1] "character"</code></pre>
<div class="sourceCode"><pre class="downlit">
<span class="va">feat1</span><span class="op">$</span><span class="fu">doSum</span><span class="op">(</span><span class="fl">3L</span>, <span class="fl">4.1</span><span class="op">)</span></pre></div>
<pre><code>## </code></pre>
<pre><code>## [1] 7.1</code></pre>
<div class="sourceCode"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">feat1</span><span class="op">$</span><span class="fu">doSum</span><span class="op">(</span><span class="fl">3L</span>, <span class="fl">4.1</span><span class="op">)</span><span class="op">)</span></pre></div>
<pre><code>## </code></pre>
<pre><code>## [1] "numeric"</code></pre>
<div class="sourceCode"><pre class="downlit">
<span class="va">feat1</span><span class="op">$</span><span class="fu">doSum</span><span class="op">(</span><span class="fl">3.0</span>, <span class="cn">NA_real_</span><span class="op">)</span></pre></div>
<pre><code>## 2022-06-23 13:32:18,043 INFO uk.co.terminological.rjava.test.FeatureTest [main] Java threw a NPE - could have had a NA input?</code></pre>
<pre><code>## [1] NA</code></pre>
<div class="sourceCode"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">feat1</span><span class="op">$</span><span class="fu">doSum</span><span class="op">(</span><span class="fl">3.0</span>, <span class="cn">NA_real_</span><span class="op">)</span><span class="op">)</span></pre></div>
<pre><code>## 2022-06-23 13:32:18,044 INFO uk.co.terminological.rjava.test.FeatureTest [main] Java threw a NPE - could have had a NA input?</code></pre>
<pre><code>## [1] "numeric"</code></pre>
<p>Wrapping and unwrapping every datatype is inconvenient for the Java programmer so some single valued primitive types are supported as parameters and return types of Java functions, particularly <code>int</code>, <code>char</code>, <code>double</code>, <code>boolean</code>, and <code>java.lang.String</code>, but these come with constraints on use, particularly around NA values in R.</p>
<div class="sourceCode"><pre class="downlit">
<span class="va">feat1</span><span class="op">$</span><span class="fu">doSum2</span><span class="op">(</span><span class="fl">3L</span>, <span class="fl">4L</span><span class="op">)</span></pre></div>
<pre><code>## </code></pre>
<pre><code>## [1] 7</code></pre>
<div class="sourceCode"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">feat1</span><span class="op">$</span><span class="fu">doSum2</span><span class="op">(</span><span class="fl">3L</span>, <span class="fl">4L</span><span class="op">)</span><span class="op">)</span></pre></div>
<pre><code>## </code></pre>
<pre><code>## [1] "integer"</code></pre>
<div class="sourceCode"><pre class="downlit">
<span class="co"># casts inputs to integer</span>
<span class="va">feat1</span><span class="op">$</span><span class="fu">doSum2</span><span class="op">(</span><span class="fl">3.0</span>,<span class="fl">4.0</span><span class="op">)</span></pre></div>
<pre><code>## </code></pre>
<pre><code>## [1] 7</code></pre>
<div class="sourceCode"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">feat1</span><span class="op">$</span><span class="fu">doSum2</span><span class="op">(</span><span class="fl">3.0</span>,<span class="fl">4.0</span><span class="op">)</span><span class="op">)</span></pre></div>
<pre><code>## </code></pre>
<pre><code>## [1] "integer"</code></pre>
<div class="sourceCode"><pre class="downlit">
<span class="co"># fails as expects an integer</span>
<span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span><span class="va">feat1</span><span class="op">$</span><span class="fu">doSum2</span><span class="op">(</span><span class="fl">3.0</span>,<span class="fl">4.5</span><span class="op">)</span><span class="op">)</span></pre></div>
<pre><code>## Error in self$.api$.toJava$int(b) : not an integer</code></pre>
<div class="sourceCode"><pre class="downlit">
<span class="co"># fails as NA values are not supported by primitive types</span>
<span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span><span class="va">feat1</span><span class="op">$</span><span class="fu">doSum2</span><span class="op">(</span><span class="fl">3L</span>,<span class="cn">NA_integer_</span><span class="op">)</span><span class="op">)</span></pre></div>
<pre><code>## Error in self$.api$.toJava$int(b) : cant use NA as input to java int</code></pre>
<p>Static java methods are also supported. R6 does not have a concept of static methods, so we use the root of the JavaApi as a place to hold the static methods, which in this case returns nothing (an R NULL is invisibly returned), but logs its input.</p>
<div class="sourceCode"><pre class="downlit">
<span class="va">J</span><span class="op">$</span><span class="va">FeatureTest</span><span class="op">$</span><span class="fu">demoStatic</span><span class="op">(</span><span class="st">"Hello, static world."</span><span class="op">)</span></pre></div>
<pre><code>## 2022-06-23 13:32:18,192 INFO uk.co.terminological.rjava.test.FeatureTest [main] Hello, static world.</code></pre>
</div>
<div id="more-complex-objects" class="section level2">
<h2 class="hasAnchor">
<a href="#more-complex-objects" class="anchor"></a>More complex objects</h2>
<p>The generated API has support for the loss-less bi-directional transfer of a range of R data types into Java and back to R. Extensive tests are available elsewhere but in general support for vectors, dataframes and lists is mostly complete, including factors, but matrices and arrays are not yet implemented. Dataframes with named rows are also not yet supported. Dataframes as well as other objects can be serialised in Java and de-serialised. This serialisation has been done for the ggplot2::diamonds data set, and the resulting de-serialisation shown here. Factor levels and ordering are preserved when the factor is part of a vector or dataframe.</p>
<pre><code>CANNOT FIND FILE - possibly if running in R-CMD-check</code></pre>
<p>The basic smoke tests of this are as follows</p>
<div class="sourceCode"><pre class="downlit">
<span class="va">feat1</span><span class="op">$</span><span class="fu">doSomethingWithDataFrame</span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="va"><a href="https://ggplot2.tidyverse.org/reference/diamonds.html">diamonds</a></span><span class="op">)</span></pre></div>
<pre><code>## 2022-06-23 13:32:18,381 INFO uk.co.terminological.rjava.test.FeatureTest [main] dataframe length: 53940</code></pre>
<div class="sourceCode"><pre class="downlit">
<span class="va">feat1</span><span class="op">$</span><span class="fu">generateDataFrame</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">glimpse</span><span class="op">(</span><span class="op">)</span></pre></div>
<pre><code>## </code></pre>
<pre><code>## Rows: 10
## Columns: 2
## $ index &lt;int&gt; 0, 1, 2, 3, 4, 5, 6, 7, 8, 9
## $ value &lt;int&gt; 10, 9, 8, 7, 6, 5, 4, 3, 2, 1</code></pre>
<div class="sourceCode"><pre class="downlit">
<span class="va">J</span><span class="op">$</span><span class="va">FeatureTest</span><span class="op">$</span><span class="fu">diamonds</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">glimpse</span><span class="op">(</span><span class="op">)</span></pre></div>
<pre><code>## </code></pre>
<pre><code>## Rows: 53,940
## Columns: 10
## $ carat   &lt;dbl&gt; 0.23, 0.21, 0.23, 0.29, 0.31, 0.24, 0.24, 0.26, 0.22, 0.23, 0.…
## $ cut     &lt;ord&gt; Ideal, Premium, Good, Premium, Good, Very Good, Very Good, Ver…
## $ color   &lt;ord&gt; E, E, E, I, J, J, I, H, E, H, J, J, F, J, E, E, I, J, J, J, I,…
## $ clarity &lt;ord&gt; SI2, SI1, VS1, VS2, SI2, VVS2, VVS1, SI1, VS2, VS1, SI1, VS1, …
## $ depth   &lt;dbl&gt; 61.5, 59.8, 56.9, 62.4, 63.3, 62.8, 62.3, 61.9, 65.1, 59.4, 64…
## $ table   &lt;dbl&gt; 55, 61, 65, 58, 58, 57, 57, 55, 61, 61, 55, 56, 61, 54, 62, 58…
## $ price   &lt;int&gt; 326, 326, 327, 334, 335, 336, 336, 337, 337, 338, 339, 340, 34…
## $ x       &lt;dbl&gt; 3.95, 3.89, 4.05, 4.20, 4.34, 3.94, 3.95, 4.07, 3.87, 4.00, 4.…
## $ y       &lt;dbl&gt; 3.98, 3.84, 4.07, 4.23, 4.35, 3.96, 3.98, 4.11, 3.78, 4.05, 4.…
## $ z       &lt;dbl&gt; 2.43, 2.31, 2.31, 2.63, 2.75, 2.48, 2.47, 2.53, 2.49, 2.39, 2.…</code></pre>
<div class="sourceCode"><pre class="downlit">
<span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span><span class="op">(</span><span class="va">J</span><span class="op">$</span><span class="va">FeatureTest</span><span class="op">$</span><span class="fu">diamonds</span><span class="op">(</span><span class="op">)</span>, <span class="fu">ggplot2</span><span class="fu">::</span><span class="va"><a href="https://ggplot2.tidyverse.org/reference/diamonds.html">diamonds</a></span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="st">"PASS: round tripping ggplot2::diamonds including java serialisation and deserialisation works"</span><span class="op">)</span>
<span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"FAIL: serialised diamonds from Java should be identical to the ggplot source"</span><span class="op">)</span>
<span class="op">}</span></pre></div>
<pre><code>## </code></pre>
<pre><code>## PASS: round tripping ggplot2::diamonds including java serialisation and deserialisation works</code></pre>
</div>
<div id="objects-fluent-apis-and-factory-methods" class="section level2">
<h2 class="hasAnchor">
<a href="#objects-fluent-apis-and-factory-methods" class="anchor"></a>Objects, fluent apis and factory methods</h2>
<p>The generated R6 code can handle return of Java objects to R, as long as they are a part of the api and annotated with <code>@RClass</code>. A common use case for this is fluent Apis, where the Java object is manipulated by a method and returns itself.</p>
<pre><code>CANNOT FIND FILE - possibly if running in R-CMD-check</code></pre>
<p>The <code>JavaApi</code> root manages R's perspective on the identity of objects in Java. This allows for fluent api methods, and method chaining. This is not flawless but should work for most common scenarios. It is possible that complex edge cases may appear equal in Java but not identical in R, so true equality should rely on the Java <code>equals()</code> method.</p>
<div class="sourceCode"><pre class="downlit">
<span class="va">feat1</span><span class="op">$</span><span class="fu">getMessage</span><span class="op">(</span><span class="op">)</span></pre></div>
<pre><code>## </code></pre>
<pre><code>## [1] "Hello world. Creating a new object"</code></pre>
<div class="sourceCode"><pre class="downlit">
<span class="va">feat2</span> <span class="op">=</span> <span class="va">feat1</span><span class="op">$</span><span class="fu">fluentSetMessage</span><span class="op">(</span><span class="st">"Hello world. updating message."</span><span class="op">)</span></pre></div>
<pre><code>## </code></pre>
<div class="sourceCode"><pre class="downlit">
<span class="va">feat2</span><span class="op">$</span><span class="fu">getMessage</span><span class="op">(</span><span class="op">)</span></pre></div>
<pre><code>## </code></pre>
<pre><code>## [1] "Hello world. updating message."</code></pre>
<div class="sourceCode"><pre class="downlit">
<span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span><span class="op">(</span><span class="va">feat1</span>,<span class="va">feat2</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="st">"PASS: the return value of a fluent setter returns the same object as the original"</span><span class="op">)</span>
<span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">feat1</span><span class="op">$</span><span class="va">.jobj</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">feat2</span><span class="op">$</span><span class="va">.jobj</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">feat1</span><span class="op">$</span><span class="va">.jobj</span><span class="op">$</span><span class="fu">equals</span><span class="op">(</span><span class="va">feat2</span><span class="op">$</span><span class="va">.jobj</span><span class="op">)</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"FAIL: these should have been identical"</span><span class="op">)</span>
<span class="op">}</span></pre></div>
<pre><code>## PASS: the return value of a fluent setter returns the same object as the original</code></pre>
<div class="sourceCode"><pre class="downlit">
<span class="kw">if</span> <span class="op">(</span><span class="va">feat1</span><span class="op">$</span><span class="fu">equals</span><span class="op">(</span><span class="va">feat2</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="st">"PASS: java based equality detection is supported"</span><span class="op">)</span>
<span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"FAIL: these should have been equal"</span><span class="op">)</span>
<span class="op">}</span></pre></div>
<pre><code>## PASS: java based equality detection is supported</code></pre>
<div class="sourceCode"><pre class="downlit">
<span class="va">feat1</span><span class="op">$</span><span class="fu">getMessage</span><span class="op">(</span><span class="op">)</span></pre></div>
<pre><code>## </code></pre>
<pre><code>## [1] "Hello world. updating message."</code></pre>
<div class="sourceCode"><pre class="downlit">
<span class="co"># Operations on feat2 are occurring on feat1 as they are the same underlying object</span>
<span class="va">feat2</span><span class="op">$</span><span class="fu">fluentSetMessage</span><span class="op">(</span><span class="st">"Hello world. updating message again."</span><span class="op">)</span></pre></div>
<pre><code>## </code></pre>
<div class="sourceCode"><pre class="downlit">
<span class="va">feat1</span><span class="op">$</span><span class="fu">getMessage</span><span class="op">(</span><span class="op">)</span></pre></div>
<pre><code>## </code></pre>
<pre><code>## [1] "Hello world. updating message again."</code></pre>
<p>Factory methods allow java methods to create and return Java objects. This is supported as long as the objects are a part of the api and annotated with <code>@RClass</code>. Arbitrary java objects are not supported as return types and java code that tries to return such objects will throw an exception during the maven packaging phase. This is by design to enforce formal contracts between the Java code and the R api. If you want dynamic manipulation of the Java objects then the <em>jsr223</em> plugin is more appropriate for you.</p>
<pre><code>CANNOT FIND FILE - possibly if running in R-CMD-check</code></pre>
<p>This java code from refers to another class - <code>MoreFeatureTest</code> which has the following basic structure:</p>
<pre><code>CANNOT FIND FILE - possibly if running in R-CMD-check</code></pre>
<p>The <code>FeatureTest.factoryMethod(a,b)</code> method allows us to construct instances of another class. This enables builder patterns in the R api. The <code>MoreFeatureTest.create(message1,message2)</code> method demonstrates static factory methods, which return instances of the same class. Static methods are implemented as methods in the <code>JavaApi</code> root, as demonstrated here, and accessed through the root object <code>J</code>:</p>
<div class="sourceCode"><pre class="downlit">
<span class="co"># factory method from builder class</span>
<span class="va">moreFeat1</span> <span class="op">=</span> <span class="va">feat1</span><span class="op">$</span><span class="fu">factoryMethod</span><span class="op">(</span><span class="st">"Hello"</span>,<span class="st">"World"</span><span class="op">)</span></pre></div>
<pre><code>## 2022-06-23 13:32:20,339 INFO uk.co.terminological.rjava.test.MoreFeatureTest [main] constuctor: Hello, World</code></pre>
<div class="sourceCode"><pre class="downlit">
<span class="co"># static factory method accessed through the root of the API</span>
<span class="va">moreFeat2</span> <span class="op">=</span> <span class="va">J</span><span class="op">$</span><span class="va">MoreFeatureTest</span><span class="op">$</span><span class="fu">create</span><span class="op">(</span><span class="st">"Ola"</span>,<span class="st">"El Mundo"</span><span class="op">)</span></pre></div>
<pre><code>## 2022-06-23 13:32:20,344 INFO uk.co.terminological.rjava.test.MoreFeatureTest [main] constuctor: Ola, El Mundo</code></pre>
<div class="sourceCode"><pre class="downlit">
<span class="co"># either of these can be passed as a parameter</span>
<span class="va">feat1</span><span class="op">$</span><span class="fu">objectAsParameter</span><span class="op">(</span><span class="va">moreFeat1</span><span class="op">)</span></pre></div>
<pre><code>## </code></pre>
<pre><code>## [1] "toString: World"</code></pre>
</div>
<div id="logging-printing-and-exceptions" class="section level2">
<h2 class="hasAnchor">
<a href="#logging-printing-and-exceptions" class="anchor"></a>Logging, printing and exceptions</h2>
<p>The logging sub-system is based on <code>slf4j</code> with a <code>log4j2</code> implementation. These are specified in the <code>r6-generator-runtime</code> dependency pom, so anything that imports that will have them as a transitive dependency. These are needed as dynamic alteration of the logging level from R is dependent on implementation details of <code>log4j</code>. This is maybe possible to remove in the future.</p>
<p>Exceptions thrown from Java are handled in the same way as <em>rJava</em>, and printed messages are seen on the R console as expected. However rJava does something strange to messages from <code>System.out</code> that means they do not appear in knitr output. To resolve this a unsightly workaround (hack) has been adopted that collects messages from system out and prints them after the Java method has completed. This has the potential to cause all sorts of issues, which I think I have mostly resolved.</p>
<p>The logging level can be controlled at runtime by a function in the <code>JavaApi</code> root. Logging can be configured dynamically with a <code>log4j</code> properties file (not shown) to enable file based logging, for example.</p>
<pre><code>CANNOT FIND FILE - possibly if running in R-CMD-check</code></pre>
<div class="sourceCode"><pre class="downlit">
<span class="co"># System.out printing</span>
<span class="va">moreFeat1</span><span class="op">$</span><span class="fu">printMessage</span><span class="op">(</span><span class="op">)</span></pre></div>
<pre><code>## Printed in java: Hello World</code></pre>
<div class="sourceCode"><pre class="downlit">
<span class="co"># Testing logging levels</span>
<span class="va">J</span><span class="op">$</span><span class="fu">changeLogLevel</span><span class="op">(</span><span class="st">"ALL"</span><span class="op">)</span>
<span class="va">moreFeat1</span><span class="op">$</span><span class="fu">testLogging</span><span class="op">(</span><span class="op">)</span></pre></div>
<pre><code>## 2022-06-23 13:32:20,484 ERROR uk.co.terminological.rjava.test.MoreFeatureTest [main] An error
## 2022-06-23 13:32:20,484 WARN uk.co.terminological.rjava.test.MoreFeatureTest [main] A warning
## 2022-06-23 13:32:20,484 INFO uk.co.terminological.rjava.test.MoreFeatureTest [main] A info
## 2022-06-23 13:32:20,484 DEBUG uk.co.terminological.rjava.test.MoreFeatureTest [main] A debug
## 2022-06-23 13:32:20,484 TRACE uk.co.terminological.rjava.test.MoreFeatureTest [main] A trace</code></pre>
<div class="sourceCode"><pre class="downlit">
<span class="co"># Suppressing errors</span>
<span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span><span class="va">moreFeat1</span><span class="op">$</span><span class="fu">throwCatchable</span><span class="op">(</span><span class="op">)</span>,silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></pre></div>
<pre><code>## </code></pre>
<div class="sourceCode"><pre class="downlit">
<span class="co"># Handling errors</span>
<span class="kw"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span><span class="op">(</span>
  <span class="op">{</span>
    <span class="va">moreFeat1</span><span class="op">$</span><span class="fu">throwRuntime</span><span class="op">(</span><span class="op">)</span>
  <span class="op">}</span>, 
  error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="st">"the error object has a set of classes: "</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">e</span><span class="op">)</span>,collapse<span class="op">=</span><span class="st">";"</span><span class="op">)</span><span class="op">)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/warning.html">warning</a></span><span class="op">(</span><span class="st">"error: "</span>,<span class="va">e</span><span class="op">$</span><span class="va">message</span><span class="op">)</span>
    <span class="co"># the e$jobj entry gives native access to the throwable java object thanks to rJava.</span>
    <span class="va">e</span><span class="op">$</span><span class="va">jobj</span><span class="op">$</span><span class="fu">printStackTrace</span><span class="op">(</span><span class="op">)</span>
  <span class="op">}</span>, 
  finally <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"finally"</span><span class="op">)</span>
<span class="op">)</span></pre></div>
<pre><code>## </code></pre>
<pre><code>## the error object has a set of classes: RuntimeException;Exception;Throwable;Object;error;condition</code></pre>
<pre><code>## Warning in value[[3L]](cond): error: java.lang.RuntimeException: A runtime
## exception has been thrown</code></pre>
<pre><code>## [1] "finally"</code></pre>
<div class="sourceCode"><pre class="downlit">
<span class="va">J</span><span class="op">$</span><span class="fu">changeLogLevel</span><span class="op">(</span><span class="st">"ERROR"</span><span class="op">)</span>
<span class="va">moreFeat1</span><span class="op">$</span><span class="fu">testLogging</span><span class="op">(</span><span class="op">)</span></pre></div>
<pre><code>## 2022-06-23 13:32:20,490 ERROR uk.co.terminological.rjava.test.MoreFeatureTest [main] An error</code></pre>
<div class="sourceCode"><pre class="downlit">
<span class="co"># J$reconfigureLog("/path/to/log4j.prop")</span></pre></div>
</div>
<div id="finalising-and-clean-up" class="section level2">
<h2 class="hasAnchor">
<a href="#finalising-and-clean-up" class="anchor"></a>Finalising and clean up</h2>
<p>The java objects bound to R instances will stay in memory whilst they are needed. When they go out of scope they should automatically be garbage collected as a native feature of <code>rJava</code>. R6 object finalizers are also generated when specified by the code and these are triggered during release of the Java objects, and may call any closing code needed in the java library (e.g. closing input streams etc).</p>
<div class="sourceCode"><pre class="downlit">
<span class="va">feat1</span> <span class="op">=</span> <span class="va">J</span><span class="op">$</span><span class="va">FeatureTest</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>logMessage <span class="op">=</span> <span class="st">"Hello world. Creating a new object"</span><span class="op">)</span></pre></div>
<pre><code>## </code></pre>
<div class="sourceCode"><pre class="downlit">
<span class="va">feat1</span><span class="op">$</span><span class="fu">doHelloWorld</span><span class="op">(</span><span class="op">)</span></pre></div>
<pre><code>## </code></pre>
<pre><code>## [1] "Hello world from Java!"</code></pre>
<p>When an object goes out of scope the finalizer will be called. This can happen much later, and any errors thrown by the finaliser code could cause issues. Code run in these finalizers can throw unchecked exceptions which are ignored and converted to logged errors.</p>
<div class="sourceCode"><pre class="downlit">
<span class="va">feat1</span> <span class="op">=</span> <span class="cn">NULL</span>
<span class="fu"><a href="https://rdrr.io/r/base/gc.html">gc</a></span><span class="op">(</span><span class="op">)</span></pre></div>
<pre><code>##           used (Mb) gc trigger  (Mb) max used  (Mb)
## Ncells 1213638 64.9    2207460 117.9  2207460 117.9
## Vcells 2491860 19.1    8388608  64.0  7318422  55.9</code></pre>
<p>The finalizer should also be called implicitly when the R6 object goes out of scope in R.</p>
</div>
<div id="support-for-debugging" class="section level2">
<h2 class="hasAnchor">
<a href="#support-for-debugging" class="anchor"></a>Support for debugging</h2>
<p>Debugging compiled java code running in the context of a R is not for the faint-hearted. It definitely makes sense to test and debug the java code in Java first. To make this possible it is useful to be able to serialise some test data in the exact format in which it will arrive in Java from R. To that end all the Java structures supported can be serialised, and de-serialised for testing purposes. The <code>testRapi</code> library presented here has a set of functions that facilitate this as static methods of <code>J$Serialiser</code>.</p>
<pre><code>CANNOT FIND FILE - possibly if running in R-CMD-check</code></pre>
<div class="sourceCode"><pre class="downlit">
<span class="va">s</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"diamonds"</span>, fileext <span class="op">=</span> <span class="st">".ser"</span><span class="op">)</span>
<span class="va">J</span><span class="op">$</span><span class="va">Serialiser</span><span class="op">$</span><span class="fu">serialiseDataframe</span><span class="op">(</span>dataframe <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="va"><a href="https://ggplot2.tidyverse.org/reference/diamonds.html">diamonds</a></span>, filename <span class="op">=</span> <span class="va">s</span><span class="op">)</span></pre></div>
<pre><code>## </code></pre>
<div class="sourceCode"><pre class="downlit">
<span class="va">J</span><span class="op">$</span><span class="va">Serialiser</span><span class="op">$</span><span class="fu">deserialiseDataframe</span><span class="op">(</span>filename<span class="op">=</span><span class="va">s</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">glimpse</span><span class="op">(</span><span class="op">)</span></pre></div>
<pre><code>## </code></pre>
<pre><code>## Rows: 53,940
## Columns: 10
## $ carat   &lt;dbl&gt; 0.23, 0.21, 0.23, 0.29, 0.31, 0.24, 0.24, 0.26, 0.22, 0.23, 0.…
## $ cut     &lt;ord&gt; Ideal, Premium, Good, Premium, Good, Very Good, Very Good, Ver…
## $ color   &lt;ord&gt; E, E, E, I, J, J, I, H, E, H, J, J, F, J, E, E, I, J, J, J, I,…
## $ clarity &lt;ord&gt; SI2, SI1, VS1, VS2, SI2, VVS2, VVS1, SI1, VS2, VS1, SI1, VS1, …
## $ depth   &lt;dbl&gt; 61.5, 59.8, 56.9, 62.4, 63.3, 62.8, 62.3, 61.9, 65.1, 59.4, 64…
## $ table   &lt;dbl&gt; 55, 61, 65, 58, 58, 57, 57, 55, 61, 61, 55, 56, 61, 54, 62, 58…
## $ price   &lt;int&gt; 326, 326, 327, 334, 335, 336, 336, 337, 337, 338, 339, 340, 34…
## $ x       &lt;dbl&gt; 3.95, 3.89, 4.05, 4.20, 4.34, 3.94, 3.95, 4.07, 3.87, 4.00, 4.…
## $ y       &lt;dbl&gt; 3.98, 3.84, 4.07, 4.23, 4.35, 3.96, 3.98, 4.11, 3.78, 4.05, 4.…
## $ z       &lt;dbl&gt; 2.43, 2.31, 2.31, 2.63, 2.75, 2.48, 2.47, 2.53, 2.49, 2.39, 2.…</code></pre>
<p>With serialised test data, as dataframes, lists or named lists, development of java functions and unit tests can be created that output values of the correct <code>RObject</code> datatype. Correct packaging and integration with R is a question of running <code>mvn install</code> to compile the Java into a jar file and generate R library code, then using <code><a href="https://devtools.r-lib.org/reference/install.html">devtools::install</a></code> to install the generated R library.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="co"># compile Java code and package R library using `mvn install` command</span>
<span class="kw">cd</span> ~/Git/r6-generator-docs/src
<span class="kw">mvn</span> install</code></pre></div>
<div class="sourceCode"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/getwd.html">setwd</a></span><span class="op">(</span><span class="st">"~/Git/r6-generator-docs"</span><span class="op">)</span>
<span class="co"># remove previously installed versions</span>
<span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/detach.html">detach</a></span><span class="op">(</span><span class="st">"package:testRapi"</span>, unload <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/remove.packages.html">remove.packages</a></span><span class="op">(</span><span class="st">"testRapi"</span><span class="op">)</span>
<span class="co"># rm(list = ls()) may be required to clear old versions of the library code</span>
<span class="co"># Restarting R maybe also required if there was a running java VM otherwise changes to the jars on the classpath are not picked up.</span>
<span class="co"># install locally compiled R library:</span>
<span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/install.html">install</a></span><span class="op">(</span><span class="st">"~/Git/r6-generator-docs"</span>, upgrade <span class="op">=</span> <span class="st">"never"</span><span class="op">)</span>
<span class="co"># N.B. devtools::load_all() does not appear to always successfully pick up changes in the compiled java code</span></pre></div>
<p>For initial integration testing there is a debug flag in the maven <code>pom.xml</code> that enables remote java debugging to the initialized when the library is first loaded in R. When set to true a java debugging session on port 8998 is opened which can be connected to as a remote java application. This allows breakpoints to be set on Java code and the state of the JVM to be inspected when Java code is executed from R, however Java code changes cannot be hot-swapped into the running JVM, and so debugging integration issues is relatively limited. For more details see the <a href="./R6-generator-maven-config">Maven configuration vignette</a>.</p>
<p>There are other limitations with enabling java debugging, not least being the potential for port conflicts with multiple running instances of the development library, and caching issues between running and loaded versions of the Java code. Whilst not too painful (compared to the alternatives) this is very definitely not a REPL experience and reserved for the last stage of debugging. Part of the purpose of strongly enforcing a datatype conversion contract between Java and R, and extensive use of code generation, is to decouple Java and R development as much as possible (N.B. do as I say - not as I do).</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Rob Challen, terminological, Rob Challen.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
